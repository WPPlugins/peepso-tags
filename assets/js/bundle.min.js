!function(a,b,c,d){var e=function(a,b,c){function d(a,b){return this.textarea=a,this.options=b||{},this.init(),this}var e=/@\[\[(\d+):user:([^\]]+)\]\]/g,f=/@\[\[(\d+):user:([^\]]+)\]\]/,g=/\n/g,h=".ps-tagging-wrapper",i=".ps-tagging-beautifier",j=".ps-tagging-hidden",k=".ps-tagging-dropdown",l=".ps-tagging-dropdown-item",m=".active";return d.prototype.init=function(){this.dom_prepare(),this.textarea.value&&(this.parse_tags(),this.textarea_on_input()),this.$textarea.off(".ps-tagging").on("focus.ps-tagging",a.proxy(this.textarea_on_keydown,this)).on("click.ps-tagging",a.proxy(this.textarea_on_keydown,this)).on("keydown.ps-tagging",a.proxy(this.textarea_on_keydown,this)).on("keyup.ps-tagging",a.proxy(this.textarea_on_keyup,this)).on("input.ps-tagging",a.proxy(this.textarea_on_input,this)).on("blur.ps-tagging",a.proxy(this.textarea_on_blur,this)),this.$dropdown.off(".ps-tagging").on("mouseenter.ps-tagging",l,a.proxy(this.dropdown_on_mouseenter,this)).on("mousedown.ps-tagging",l,a.proxy(this.dropdown_on_mousedown,this)).on("mouseup.ps-tagging",l,a.proxy(this.dropdown_on_mouseup,this))},d.prototype.dom_prepare=function(){this.$textarea=a(this.textarea),this.$textarea.addClass(".ps-tagging-textarea".substr(1)),this.$wrapper=this.$textarea.parent(h),this.$wrapper.length||(this.$textarea.wrap('<div class="'+h.substr(1)+'"></div>'),this.$wrapper=this.$textarea.parent()),this.$beautifier=this.$wrapper.children(i),this.$beautifier.length||(this.$beautifier=a('<div class="'+i.substr(1)+'"></div>'),this.$beautifier.prependTo(this.$wrapper)),this.$hidden=this.$wrapper.children(j),this.$hidden.length||(this.$hidden=a('<input type="hidden" class="'+j.substr(1)+'">'),this.$hidden.appendTo(this.$wrapper)),this.$dropdown=this.$wrapper.children(k),this.$dropdown.length||(this.$dropdown=a('<div class="'+k.substr(1)+'"></div>'),this.$dropdown.appendTo(this.$wrapper))},d.prototype.parse_tags=function(){var a,b,c,d,g,h,g=this.textarea.value;if(this.options.parser&&(a=this.options.parser_groups||{},g=g.replace(this.options.parser,function(){return"@[["+(arguments[a.id]||"")+":user:"+(arguments[a.title]||"")+"]]"})),b=g.match(e),this.textarea.value=g.replace(e,"$2"),this.tags_added=[],b&&b.length)for(h=0;h<b.length;h++)c=b[h].match(f),d=g.indexOf(b[h]),g=g.replace(b[h],c[2]),this.tags_added.push({id:c[1],name:c[2],start:d,length:c[2].length})},d.prototype.reset=function(){var a=this.textarea.value="",b=this.tags_added=[];this.beautifier_update(a,b),this.hidden_update(a,b),this.dropdown_hide()},d.prototype.val=function(){var b=this.$hidden.val();return"function"==typeof this.options.syntax&&(b=b.replace(/@\[\[(\d+):user:([^\]]+)\]\]/g,a.proxy(function(a,b,c){return this.options.syntax({id:b,title:c})},this))),b},d.prototype.textarea_on_keydown=function(a){var b=a.keyCode;this.dropdown_is_visible&&[13,27,38,40].indexOf(b)>=0&&(a.preventDefault(),a.stopPropagation()),this.prev_sel_start=this.textarea.selectionStart,this.prev_sel_end=this.textarea.selectionEnd},d.prototype.textarea_on_keyup=function(a){var b=a.keyCode;this.dropdown_is_visible&&(38!==b&&40!==b||(this.dropdown_change_item(b),a.preventDefault(),a.stopPropagation()),13===b&&(this.dropdown_select_item(),a.preventDefault(),a.stopPropagation()),27===b&&(this.dropdown_hide(),a.preventDefault(),a.stopPropagation()))},d.prototype.textarea_on_input=function(a){var b,c,d,e,f,g,h,i,j,k,l,m=this.textarea.value;if(this.tags_added){if(this.prev_sel_start!==this.prev_sel_end)for(k=0;k<this.tags_added.length;k++)c=this.tags_added[k],d=c.start+c.length,(this.prev_sel_start>c.start&&this.prev_sel_start<d||this.prev_sel_end>c.start&&this.prev_sel_end<d||c.start>=this.prev_sel_start&&d<=this.prev_sel_end)&&this.tags_added.splice(k--,1);for(b=this.textarea.selectionStart-this.prev_sel_start-(this.prev_sel_end-this.prev_sel_start),k=0;k<this.tags_added.length;k++)if(c=this.tags_added[k],c.start>=this.prev_sel_start)c.start+=b;else if((d=c.start+c.length)<this.prev_sel_start);else if(d>this.prev_sel_start){if(b>0)this.tags_added.splice(k--,1);else if(b<0){for(e=m.substring(c.start,this.prev_sel_start+b),g=e.split(" ").length-1,e=c.name.split(" "),e.splice(g,1),e=e.join(" "),f=c.name.split(" "),f=f.slice(0,g),f=f.join(" "),h=new RegExp("^([\\s\\S]{"+c.start+"})([\\s\\S]{"+(c.length+b)+"})"),i="$1"+e,this.textarea.value=this.textarea.value.replace(h,i),this.textarea.setSelectionRange(c.start+f.length,c.start+f.length),m=this.textarea.value,j=c.length-e.length,c.name=e,c.length=e.length,l=k+1;l<this.tags_added.length;l++)this.tags_added[l].start-=j;e.length||this.tags_added.splice(k--,1),k=this.tags_added.length}}else if(b<0){for(e=c.name.split(" "),e.pop(),e=e.join(" "),h=new RegExp("^([\\s\\S]{"+c.start+"})([\\s\\S]{"+(c.length+b)+"})"),i="$1"+e,this.textarea.value=this.textarea.value.replace(h,i),this.textarea.setSelectionRange(c.start+e.length,c.start+e.length),m=this.textarea.value,j=c.length-e.length,c.name=e,c.length=e.length,l=k+1;l<this.tags_added.length;l++)this.tags_added[l].start-=j;e.length||this.tags_added.splice(k--,1),k=this.tags_added.length}}this.beautifier_update(m,this.tags_added||[]),this.hidden_update(m,this.tags_added||[]),this.dropdown_toggle()},d.prototype.textarea_on_blur=function(a){},d.prototype.beautifier_update=b.debounce(function(a,b){var c,d,e,f,h;if(b.length){for(c="^",d="",e=0,h=0;h<b.length;h++)f=b[h],c+="([\\s\\S]{"+(f.start-e)+"})([\\s\\S]{"+f.length+"})",d+="$"+(2*h+1)+'<span class="ps-tag">'+f.name+"</span>",e=f.start+f.length;c=new RegExp(c),a=a.replace(c,d)}a=a.replace(g,"<br>"),this.$beautifier.html(a)},1),d.prototype.hidden_update=b.debounce(function(a,b){var c,d,e,f,g;if(b.length){for(c="^",d="",e=0,g=0;g<b.length;g++)f=b[g],c+="([\\s\\S]{"+(f.start-e)+"})([\\s\\S]{"+f.length+"})",d+="$"+(2*g+1)+"@[["+f.id+":user:"+f.name+"]]",e=f.start+f.length;c=new RegExp(c),a=a.replace(c,d)}this.$hidden.val(a)},50),d.prototype.dropdown_toggle=b.debounce(function(){var b=this.textarea.selectionStart,c=this.textarea.value.substr(0,b),d=c.lastIndexOf("@");if(d<0||++d>=b)return void this.dropdown_hide();c=c.substring(d,b),this.dropdown_fetch(c,a.proxy(this.dropdown_update,this))},200),d.prototype.dropdown_fetch=function(b,c){if("function"!=typeof this.options.fetcher)return void c(b,[]);this.dropdown_fetching||(this.dropdown_fetching=!0,this.$dropdown.find(".ps-tagging-loading").show(),this.options.fetcher(b,a.proxy(function(a,d){this.$dropdown.find(".ps-tagging-loading").hide(),this.dropdown_fetching=!1,"cache"===d?c(b,a):this.dropdown_toggle()},this)))},d.prototype.dropdown_filter=function(a,c){var d=[];return this.tags_added&&this.tags_added.length&&(d=b.map(this.tags_added,function(a){return""+a.id})),a=a.toLowerCase(),b.filter(c,function(b){return-1===d.indexOf(""+b.id)&&b.name.toLowerCase().indexOf(a)>-1})},d.prototype.dropdown_update=function(a,b){var c,d;if(b=this.dropdown_filter(a,b),b.length){for(c="",d=0;d<b.length;d++)c+='<div class="'+l.substr(1)+'" data-id="'+b[d].id+'" data-name="'+b[d].name+'">',c+='<a href="javascript:"><div class="ps-avatar"><img src="'+b[d].avatar+'"></div><span>'+b[d].name+"</span></a>",c+="</div>";this.dropdown_show(c)}},d.prototype.dropdown_show=function(a){this.$dropdown.html(a).show(),this.dropdown_is_visible=!0},d.prototype.dropdown_show_more=function(){},d.prototype.dropdown_hide=function(){this.$dropdown.hide(),this.dropdown_is_visible=!1},d.prototype.dropdown_on_mouseenter=function(a){this.dropdown_change_item(a)},d.prototype.dropdown_on_mousedown=function(){this.dropdown_is_clicked=!0},d.prototype.dropdown_on_mouseup=function(a){this.dropdown_select_item(a),this.dropdown_is_clicked=!1,this.dropdown_hide()},d.prototype.dropdown_change_item=function(b){var c,d,e,f=m.substr(1);return"number"!=typeof b?(c=this.dropdown_selected_item=a(b.target),d=c.siblings(m),c.addClass(f),void d.removeClass(f)):(c=this.$dropdown.children(m),c.length?(e=c[38===b?"prev":"next"](),c.removeClass(f),void(e.length?(this.dropdown_selected_item=e,e.addClass(f)):this.dropdown_selected_item=!1)):(c=this.dropdown_selected_item=this.$dropdown.children()[38===b?"last":"first"](),void c.addClass(f)))},d.prototype.dropdown_select_item=function(b){var c,d,e=b?a(b.currentTarget):this.dropdown_selected_item,f=e.data("id"),g=e.data("name"),h=this.textarea.selectionStart,i=this.textarea.value.substr(0,h),j=i.lastIndexOf("@");this.tags_added||(this.tags_added=[]),this.tags_added.push({id:f,name:g,start:j,length:g.length}),c=new RegExp("^([\\s\\S]{"+j+"})[\\s\\S]{"+(h-j)+"}"),d=this.textarea.value.replace(c,"$1"+g),this.textarea.value=d,this.textarea.setSelectionRange(j+g.length,j+g.length),this.beautifier_update(d,this.tags_added),this.hidden_update(d,this.tags_added),this.dropdown_hide(),this.$textarea.focus()},d}(a,b,c);a.fn.ps_tagging=function(b,c){return"object"==typeof b&&(c=b),this.each(function(){var d=a(this),f=d.data("ps_tagging");f||(f=new e(this,c),d.data("ps_tagging",f)),"val"===b&&"function"==typeof c?c(f.val()):"reset"===b&&f.reset()})}}(jQuery||$,_,peepso),function(a,b,c){!function(a,b,c){function d(){}d.prototype.init=function(){var b=this;this.taggable_inputs=ps_observer.apply_filters("peepsotags_taggable_inputs",["#postbox-main textarea.ps-postbox-textarea"]),this.init_tags(this.taggable_inputs.join(",")),this.init_tags_comments(),a(document).on("peepso_tags_init_comments ps_activitystream_append ps_activitystream_loaded peepso_repost_added",function(){b.init_tags_comments()}),ps_observer.add_filter("postbox_req_edit",function(a,b){return b.ps_tagging("val",function(b){a.post=b}),a},10,2),ps_observer.add_filter("comment_req",function(b,c){return a(c).ps_tagging("val",function(a){b.content=a,b.post=a}),b},10,2),ps_observer.add_filter("comment_cancel",function(b){a(b).ps_tagging("reset")},10,2),ps_observer.add_filter("modalcomments.afterchange",function(a){a&&a.$attachment&&a.$attachment.find(".ps-comment-reply textarea").ps_tagging()},10,2),ps_observer.add_filter("caption_req",function(b,c){return a(c).ps_tagging("val",function(a){b.description=a}),b},10,2),ps_observer.add_filter("comment.reply",function(a,c){if(c.id!=peepsodata.currentuserid&&c.id&&c.name){var d=_.template(peepsotagsdata.template);a.val(d({id:c.id,title:c.name})+" "),a.removeData("ps_tagging"),b.init_tags_comments(a)}},10,2),a("#peepso-wrap").on("comment.saved",function(b,c,d,e){a(d).ps_tagging("reset")}),a("#peepso-wrap").on("post_edit.shown",function(a,c,d){var e=d.find("textarea");b.init_tags(e)}),ps_observer.add_action("comment_edit",a.proxy(function(b,c){var d=a(c).find("textarea");this.init_tags(d)},this),10,2),ps_observer.add_action("postbox_update",a.proxy(function(a){this.init_tags(a.$text)},this),10,1),ps_observer.add_filter("postbox_data",function(a,b){return b.$text.ps_tagging("val",function(b){a.content=b}),a},10,2)},d.prototype.init_tags=function(c){var d,e=!1,f=!1;a(c).one("focus.get_taggable",function(){var a=ps_observer.apply_filters("tags_get_taggable_params",{});e=!0,b.postJson("tagsajax.get_taggable",a,function(a){a.success&&(d=a.data.users),"function"==typeof f&&f(d||[]),e=!1})}),a(c).ps_tagging({syntax:_.template(peepsotagsdata.template),parser:new RegExp(peepsotagsdata.parser,"gi"),parser_groups:{id:1,title:2},fetcher:function(a,c){if(d)return void c(d,"cache");if(e)return void(f=c);var g=ps_observer.apply_filters("tags_get_taggable_params",{});b.postJson("tagsajax.get_taggable",g,function(a){a.success&&(d=a.data.users),c(d||[])})}})},d.prototype.init_tags_comments=function(c){c||(c='[data-type="stream-newcomment"] textarea[name="comment"]'),a(c).each(function(c,d){var e,f=!1,g=!1;a(d).one("focus.get_taggable",function(){var c=ps_observer.apply_filters("tags_get_taggable_params",{act_id:a(d).data("act-id")});f=!0,b.postJson("tagsajax.get_taggable",c,function(a){a.success&&(e=a.data.users),"function"==typeof g&&g(e||[]),f=!1})}),a(d).ps_tagging({syntax:_.template(peepsotagsdata.template),parser:new RegExp(peepsotagsdata.parser,"gi"),parser_groups:{id:1,title:2},fetcher:function(c,h){if(e)return void h(e,"cache");if(f)return void(g=h);var i=ps_observer.apply_filters("tags_get_taggable_params",{act_id:a(d).data("act-id")});b.postJson("tagsajax.get_taggable",i,function(a){a.success&&(e=a.data.users),h(e||[])})}}),ps_observer.add_filter("comment_can_submit",function(b){return a(b.el).data("ps_tagging").dropdown_is_visible&&(b.can_submit=!1),b},20,1),a(d).ps_autosize()})},d.prototype.apply_line_breaks=function(a){function b(a){return d.value=a,d.scrollWidth>g}function c(a,d,e){var f;if(void 0===d)d=0,e=-1,f=64;else if(-1===e)f=2*d;else{if(e-d<=1)return Math.max(2,e);f=d+(e-d)/2}if(b(a.substr(0,f)))e=f;else{if(f>=a.length)return null;d=f}return c(a,d,e)}var d=a;d.wrap,d.setAttribute("wrap","off");var e=d.value;d.value="";for(var f,g=d.scrollWidth,h=0,i="";h<e.length;){var j=c(e.substr(h));if(null===j){i+=e.substr(h);break}-1;var k=j-1;for(f=k-1;f>=0;f--){var l=e.charAt(h+f);if(" "===l||"-"===l||"+"===l){k=f+1;break}}i+=e.substr(h,k)+"\n",h+=k}d.value=i,d.setAttribute("wrap","")},a(function(){(new d).init(),a(".ps-postbox-tab.interactions .ps-button-cancel").on("click",function(){a("#postbox-main textarea.ps-postbox-textarea").ps_tagging("reset")}),a("#postbox-main .postbox-submit").on("click",function(){a("#postbox-main textarea.ps-postbox-textarea").ps_tagging("reset")})}),c.addFilter("peepso_postbox_addons",function(b){return b.push({init:a.noop,set_postbox:function(b){"postbox-main"===b.attr("id")&&c.addFilter("postbox_req_"+b.guid,function(b){return a("#postbox-main textarea.ps-postbox-textarea").ps_tagging("val",function(a){b.content=a}),b},10,1)}}),b},10,1)}(a,b,b.observer)}(jQuery||$,peepso);
//# sourceMappingURL=bundle.min.js.map